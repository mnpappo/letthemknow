{% load static %}
<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  
  <link rel="stylesheet" type="text/css" href="{% static 'styles.css' %}">

  
  <title>Let Them Know</title>
</head>

<body>
  <div id="overlay">
    <div class="cv-spinner">
      <span class="spinner"></span>
    </div>
  </div>
  <nav class="navbar navbar-expand navbar-dark bg-dark">
    <a class="navbar-brand" href="/">Let Them Know</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample02"
      aria-controls="navbarsExample02" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsExample02">
      <ul class="navbar-nav mr-auto justify-content-md-center">
        <li class="nav-item">
          <a class="nav-link" href="#">Info</a>
        </li>
      </ul>

      <button id="refresh" type="button" class="btn btn-primary" aria-label="Left Align">
        <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> Refresh
      </button>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-8">

        {% comment %} <div class="corona_info_stat">
          <div id="myCarousel" class="carousel slide vertical" data-ride="carousel">
            <!-- Carousel items -->
            <div class="carousel-inner">
              <div class="active carousel-item">
                <div id="info" class="alert alert-info small" role="alert">Some Text 1 </div>
              </div>
              <div class="carousel-item">
                <div id="info" class="alert alert-info small" role="alert">Some Text 2 </div>
              </div>
              <div class="carousel-item">
                <div id="info" class="alert alert-info small" role="alert">Some Text 3 </div>
              </div>
            </div>
          </div>
        </div> {% endcomment %}

        <div>
          <div id="info" class="alert alert-info small" role="alert">
            {% if position.address and position.user_id %}
            Location: {{ position.address }}
            {% else %}
            Please share your location to submit your response.
            {% endif %}
          </div>

          <div id="result" class="small"></div>
        </div>

        <ul class="nav nav-tabs nav-justified" id="myTab" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" id="safe-tab" data-toggle="tab" href="#safe" role="tab" aria-controls="safe"
              aria-selected="true">Safe</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="panicked-tab" data-toggle="tab" href="#panicked" role="tab" aria-controls="panicked"
              aria-selected="false">Panicked</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="affected-tab" data-toggle="tab" href="#affected" role="tab" aria-controls="affected"
              aria-selected="false">Affected</a>
          </li>
        </ul>
        <div class="tab-content" id="myTabContent">
          <div class="tab-pane fade show active" id="safe" role="tabpanel" aria-labelledby="safe-tab"></div>
          <div class="tab-pane fade" id="panicked" role="tabpanel" aria-labelledby="panicked-tab"></div>
          <div class="tab-pane fade" id="affected" role="tabpanel" aria-labelledby="affected-tab"></div>
        </div>
      </div>
      <div class="col-sm-4">

        <div class="frb-group">
          <div class="frb frb-success">
            <input type="radio" id="radio-button-1" name="radio-button" value="1" {% if position.state == '1' %}
              checked="checked" {% endif %}>
            <label for="radio-button-1">
              <span class="frb-title">I am Safe</span>
              <span class="frb-description">I think I am safe. I can manage it.</span>
            </label>
          </div>
          <div class="frb frb-warning">
            <input type="radio" id="radio-button-2" name="radio-button" value="2" {% if position.state == '2' %}
              checked="checked" {% endif %}>
            <label for="radio-button-2">
              <span class="frb-title">I am Panicked!</span>
              <span class="frb-description">I am panicked! I dont know what to do.</span>
            </label>
          </div>
          <div class="frb frb-danger">
            <input type="radio" id="radio-button-3" name="radio-button" value="3" {% if position.state == '3' %}
              checked="checked" {% endif %}>
            <label for="radio-button-3">
              <span class="frb-title">I am Affected!!</span>
              <span class="frb-description">I think I am affected! Help!!</span>
            </label>
          </div>
        </div>

      </div>

    </div>
  </div>

  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
  </script>

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
    google.charts.load('current', {
      'packages': ['geochart'],
      'mapsApiKey': 'AIzaSyDIHUCyaqDFq-oCGWz6dMTN5oybhSeoOms'
    });
    google.charts.setOnLoadCallback(drawRegionsMap);

    function drawRegionsMap() {
      var data1 = {{data1 | safe}} //safe
      var data2 = {{data2 | safe}} //panicked
      var data3 = {{data3 | safe}} //affected

      var data1 = google.visualization.arrayToDataTable([
        ['Provinces', 'City Name', 'Value', {role:'tooltip', p:{html: true}}],
        data1[0], data1[1], data1[2], data1[3], data1[4], data1[5], data1[6], data1[7],
      ]);
      var data2 = google.visualization.arrayToDataTable([
        ['Provinces', 'City Name', 'Value', {role:'tooltip', p:{html: true}}],
        data2[0], data2[1], data2[2], data2[3], data2[4], data2[5], data2[6], data2[7],
      ]);
      var data3 = google.visualization.arrayToDataTable([
        ['Provinces', 'City Name', 'Value', {role:'tooltip', p:{html: true}}],
        data3[0], data3[1], data3[2], data3[3], data3[4], data3[5], data3[6], data3[7],
      ]);

      var w = document.getElementById('safe').offsetWidth;


      var options1 = {
        region: 'BD',
        resolution: 'provinces',
        dataMode: 'regions',
        colors: ['#fff', '#28a745'],
        width: w,
        keepAspectRatio: false,
        legend: {
          textStyle: {
            color: 'blue',
            fontSize: 16
          }
        },
        tooltip: {
          isHtml: true
        },
        forceIFrame: true
      };
      var options2 = {
        region: 'BD',
        resolution: 'provinces',
        dataMode: 'regions',
        colors: ['#fff', '#ffc107'],
        width: w,
        keepAspectRatio: false,
        legend: {
          textStyle: {
            color: 'blue',
            fontSize: 16
          }
        },
        tooltip: {
          isHtml: true
        },
        forceIFrame: true
      };
      var options3 = {
        region: 'BD',
        resolution: 'provinces',
        dataMode: 'regions',
        colors: ['#fff', '#dc3545'],
        width: w,
        keepAspectRatio: false,
        legend: {
          textStyle: {
            color: 'blue',
            fontSize: 16
          }
        },
        tooltip: {
          isHtml: true
        },
        forceIFrame: true
      };

      var chart1 = new google.visualization.GeoChart(document.getElementById('safe'));
      var chart2 = new google.visualization.GeoChart(document.getElementById('panicked'));
      var chart3 = new google.visualization.GeoChart(document.getElementById('affected'));

      chart1.draw(data1, options1);
      chart2.draw(data2, options2);
      chart3.draw(data3, options3);
    }

    function initMap() {
      geocoder = new google.maps.Geocoder;
    }

    function getPosition(options) {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, ({
            code,
            message
          }) =>
          reject(Object.assign(new Error(message), {
            name: "PositionError",
            code
          })),
          options);
      });
    };

    async function main(state) {
      var position;
      try {
        position = await this.getPosition({
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 36000
        });

        var coords = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        }
        console.log('Using HTML5 Geolocation API')

        geocoder.geocode({
            'location': coords,
          },
          function (results, status) {
            if (status === 'OK') {
              if (results[0]) {
                var filtered_array = results[0].address_components.filter(function (address_component) {
                  return address_component.types.includes("administrative_area_level_2");
                });
                district = filtered_array.length ? filtered_array[0].long_name : "";

                var div_filtered_array = results[0].address_components.filter(function (address_component) {
                  return address_component.types.includes("administrative_area_level_1");
                });
                division = div_filtered_array.length ? div_filtered_array[0].long_name : "";

                callApi(state, coords, division, district, results[0].formatted_address);

                document.getElementById("info").innerHTML = `Current Location: ${results[0].formatted_address}`;
              } else {
                window.alert('No results found');
              }
            } else {
              window.alert('Geocoder failed due to: ' + status);
            }
          });
      } catch (e) {
        console.log(e)
        if (e.name == 'PositionError') {
          console.log(e.message + ". code = " + e.code);
          var settings = {
            "url": "https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyDIHUCyaqDFq-oCGWz6dMTN5oybhSeoOms",
            "method": "POST",
            "timeout": 0,
          };

          $.ajax(settings).done(function (response) {
            var coords = {
              lat: response.location.lat,
              lng: response.location.lng
            }

            console.log('Fallback, Using Google Geolocation API')

            geocoder.geocode({
                'location': coords,
              },
              function (results, status) {
                if (status === 'OK') {
                  if (results[0]) {
                    var filtered_array = results[0].address_components.filter(function (address_component) {
                      return address_component.types.includes("administrative_area_level_2");
                    });
                    district = filtered_array.length ? filtered_array[0].long_name : "";

                    var div_filtered_array = results[0].address_components.filter(function (address_component) {
                      return address_component.types.includes("administrative_area_level_1");
                    });
                    division = div_filtered_array.length ? div_filtered_array[0].long_name : "";

                    callApi(state, coords, division, district, results[0].formatted_address);

                    document.getElementById("info").innerHTML =
                      `Current Location: ${results[0].formatted_address}`;
                  } else {
                    window.alert('No results found');
                  }
                } else {
                  window.alert('Geocoder failed due to: ' + status);
                }
              });
          });
        }
      }


    }

    function callApi(state, coords, division, district, address) {

      // ajax call
      $.ajax({
        url: '{% url 'update' %}',
        data: {
          'state': state,
          'lat': coords.lat,
          'lng': coords.lng,
          'division': division,
          'district': district,
          'address': address
        },
        dataType: 'json',
        success: function (data) {
          if (data) {
            $("#result").html(
              '<div class="alert alert-success"><button type="button" class="close">×</button>Successfully Updated Record!</div>'
              );
            window.setTimeout(function () {
              $("#result .alert").fadeTo(500, 0).slideUp(500, function () {
                $(this).remove();
              });
            }, 5000);

            $('#result .alert .close').on("click", function (e) {
              $(this).parent().fadeTo(500, 0).slideUp(500);
            });
          } else {
            console.log("hoi nai, server gese");
          }
        }
      });
    }

    $(document).ready(function () {

      $('.carousel').carousel({
        interval: 3000,
        pause: false
      })

      $('#refresh').click(function () {
        window.location.reload(true);
      });

      $(':radio[name="radio-button"]').change(function () {
        var state = $(this).filter(':checked').val();
        if (navigator.geolocation) {
          console.log("clicked")
          main(state);

        } else {
          document.getElementById("info").innerHTML = 'Geolocation is not supported by this device';
        }

      });
    });
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDIHUCyaqDFq-oCGWz6dMTN5oybhSeoOms&callback=initMap"
    async defer></script>
  
</body>

</html>