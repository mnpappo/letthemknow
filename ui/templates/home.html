{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'styles.css' %}">

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {
        'packages':['geochart'],
        'mapsApiKey': 'AIzaSyDIHUCyaqDFq-oCGWz6dMTN5oybhSeoOms'
      });
      google.charts.setOnLoadCallback(drawRegionsMap);

      function drawRegionsMap() {
        // ISO 3166-2 Code
        var data = google.visualization.arrayToDataTable([
          ['Provinces', 'City Name' , 'Users'],
          ['BD-A', 'Barisal', 20],
          ['BD-B', 'Chittagong', 300],
          ['BD-C', 'Dhaka', 400],
          ['BD-D', 'Khulna', 500],
          ['BD-H', 'Mymensingh', 600],
          ['BD-E', 'Rajshahi', 700],
          ['BD-F', 'Rangpur', 300],
          ['BD-G', 'Sylhet', 500],
        ]);

        var options = {
          region: 'BD',
          resolution: 'provinces',
          dataMode: 'regions',
          colors: ['#28a745', '#ffc107', '#dc3545'],
          legend:  {textStyle: {color: 'blue', fontSize: 16}}
        };

        var chart = new google.visualization.GeoChart(document.getElementById('regions_div'));

        chart.draw(data, options);
      }

      function initMap() {
        geocoder = new google.maps.Geocoder;
      }

      function getPosition(options) {
        return new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, ({code, message}) =>
            reject(Object.assign(new Error(message), {name: "PositionError", code})),
            options);
          });
      };

      

      async function main(state) {
        var position;
        try {
          position = await this.getPosition({
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          });

          var coords = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          }
          console.log('Using HTML5 Geolocation API')

          geocoder.geocode( { 'location': coords, }, 
            function(results, status) {
              if (status === 'OK') {
                if (results[0]) {
                  var filtered_array = results[0].address_components.filter(function(address_component){
                    return address_component.types.includes("administrative_area_level_2");
                  }); 
                  district = filtered_array.length ? filtered_array[0].long_name: "";

                  var div_filtered_array = results[0].address_components.filter(function(address_component){
                    return address_component.types.includes("administrative_area_level_1");
                  }); 
                  division = div_filtered_array.length ? div_filtered_array[0].long_name: "";

                  callApi(state, coords, division, district, results[0].formatted_address);

                  document.getElementById("info").innerHTML = `Current Location: ${results[0].formatted_address}`;
                } else {
                  window.alert('No results found');
                }
              } else {
                window.alert('Geocoder failed due to: ' + status);
              }
            });
        } catch (e) {
          if (e.name == 'PositionError') {
            console.log(e.message + ". code = " + e.code);
            var settings = {
              "url": "https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyDIHUCyaqDFq-oCGWz6dMTN5oybhSeoOms",
              "method": "POST",
              "timeout": 0,
            };

            $.ajax(settings).done(function (response) {
              var coords = {
                lat: response.location.lat,
                lng: response.location.lng
              }

              console.log('Fallback, Using Google Geolocation API')

              geocoder.geocode( { 'location': coords, }, 
                function(results, status) {
                  if (status === 'OK') {
                    if (results[0]) {
                      var filtered_array = results[0].address_components.filter(function(address_component){
                        return address_component.types.includes("administrative_area_level_2");
                      }); 
                      district = filtered_array.length ? filtered_array[0].long_name: "";

                      var div_filtered_array = results[0].address_components.filter(function(address_component){
                        return address_component.types.includes("administrative_area_level_1");
                      }); 
                      division = div_filtered_array.length ? div_filtered_array[0].long_name: "";

                      callApi(state, coords, division, district, results[0].formatted_address);

                      document.getElementById("info").innerHTML = `Current Location: ${results[0].formatted_address}`;
                    } else {
                      window.alert('No results found');
                    }
                  } else {
                    window.alert('Geocoder failed due to: ' + status);
                  }
                });
            });
          }
        }

        
      }

      function callApi(state, coords, division, district, address) {
        {#console.log(state)#}
        {#console.log(coords)#}
        var lat_lng = coords
        console.log(lat_lng.lat)
        console.log(typeof(lat_lng.lat))
        var json = JSON.stringify(lat_lng);
        {#console.log(Object.keys(lat_lng));#}
        {#console.log(typeof(lat_lng))#}
        {#console.log(typeof(district))#}

        {#console.log(division)#}
        {#console.log(district)#}
        {#console.log(address)#}

        // ajax call
        $.ajax({
          url: '{% url 'update' %}',
          data: {
            'state': state,
            'lat': coords.lat,
            'lng': coords.lng,
            'division': division,
            'district': district,
            'address': address
          },
          dataType: 'json',
          success: function (data) {
            if (data) {
              console.log(data)
            } else {
              console.log("hoi nai");
            }
          }
        });
      }


      $(document).ready(function(){
        $('#refresh').click(function(){
          window.location.reload(true);
        });
        
        $(':radio[name="radio-button"]').change(function() {
          var state = $(this).filter(':checked').val();
          if(navigator.geolocation) {
            main(state);
          } else {
            document.getElementById("info").innerHTML = 'Geolocation is not supported by this device';
          }
          
        });
      });
      



    </script>
    <title>Let Them Know</title>
  </head>
  <body>
    <nav class="navbar navbar-expand navbar-dark bg-dark">
        <a class="navbar-brand" href="/">Let Them Know</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample02" aria-controls="navbarsExample02" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarsExample02">
            <ul class="navbar-nav mr-auto justify-content-md-center">
              <li class="nav-item">
                  <a class="nav-link" href="#">Info</a>
              </li>
            </ul>

            <button id="refresh" type="button" class="btn btn-primary" aria-label="Left Align">
              <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> Refresh
            </button>
            

        </div> 
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-8">
                <div>
                  <div id="info" class="alert alert-info" role="alert">
                    Please share your location to submit your response.
                  </div>
                </div>
                
                
                <div id="regions_div">

                </div>
            </div>
            <div class="col-sm-4">

                <div class="frb-group">
                  <div class="frb frb-success">
                    <input type="radio" id="radio-button-2" name="radio-button" value="1">
                    <label for="radio-button-2">
                      <span class="frb-title">I am Safe</span>
                      <span class="frb-description">I think I am safe. I can manage it.</span>
                    </label>
                  </div>
                  <div class="frb frb-warning">
                    <input type="radio" id="radio-button-4" name="radio-button" value="2">
                    <label for="radio-button-4">
                      <span class="frb-title">I am Panicked!</span>
                      <span class="frb-description">I am panicked! I dont know what to do.</span>
                    </label>
                  </div>
                  <div class="frb frb-danger">
                    <input type="radio" id="radio-button-5" name="radio-button" value="3">
                    <label for="radio-button-5">
                      <span class="frb-title">I am Effected!!</span>
                      <span class="frb-description">I think I am effected! Help!!</span>
                    </label>
                  </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDIHUCyaqDFq-oCGWz6dMTN5oybhSeoOms&callback=initMap" async defer></script>
  </body>
</html>